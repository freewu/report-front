/*! report-frontend 2017-01-12 */
!function(a){Object&&Object.values||(Object.values=function(a){return $.map(a,function(a,b){return a})});var b="file:"!=window.location.protocol?window.location.href:"",c={},d=function(a){return new e($(a))},e=function(a){this.div=a,this._report_type=null;var b=a.attr("report-id"),c=this.getReportConfig(a.attr("report-config"));if(b){var d=this.getReportData(a.attr("report-config"),a.attr("report-condition"));if(c&&c.reload_interval&&parseInt(c.reload_interval)>=10){var e=this;setInterval(function(){e.getData(b,d,c)},1e3*parseInt(c.reload_interval))}this.getData(b,d,c)}else{var d=JSON.parse(decodeURIComponent(a.attr("report-data")||"{}"));if(d){var f=c&&c.type?c.type:d.type;"table"==f?this.showTable(0,d,c):this.showChart(0,d,c)}else this._show_msg("没有设置report-id或report-data")}};e.prototype.getReportData=function(a,b){var c={};if(b){var d=JSON.parse("{"+$.trim(b)+"}");d&&(c=d)}if(a){var d=JSON.parse("{"+$.trim(a)+"}");d&&d.type&&(c.__type=d.type),d&&d.token&&(c.__token=d.token),d&&d.column&&(c.__column=d.column)}return c},e.prototype.getReportConfig=function(a){var b={};if(a){var c=JSON.parse("{"+$.trim(a)+"}");c&&(b=c),c&&c.type&&(this._report_type=c.type)}return b},e.prototype.loading=function(a){return!!jQuery.isFunction(jQuery.fn.showLoading)&&void(a?this.div.showLoading():this.div.hideLoading())},e.prototype.getData=function(d,e,f){var g=a.EZ&&a.EZ.report_remote_url?EZ.report_remote_url:b,h=this,i=null;if(!f.reload_interval){var j=e.__type;if(e.__type=null,i=d+"-"+JSON.stringify(e),c[i])return this.show(d,c[i],f),!1;e.__type=j}this.loading(!0),$.ajax({type:"get",async:!1,url:g+d,dataType:a.EZ&&a.EZ.report_remote_type?a.EZ.report_remote_type:"jsonp",data:e,success:function(a){i&&(c[i]=a),h.loading(!1),h.show(d,a,f)},error:function(){h.loading(!1),h._show_msg("获取配置信息失败: "+b+d)}})},e.prototype.show=function(a,b,c){0==b.code&&b.data?"table"==b.data.type?this.showTable(a,b.data,c):this.showChart(a,b.data,c):b.msg&&this._show_msg(b.msg)},e.prototype.showTable=function(b,c,d){if(void 0==a.Gri||void 0==Gri.initDataTable)return this._show_msg("本报表需要载入table组件"),!1;var e="ez-report-"+b+" - "+Math.ceil(1e3*Math.random());this.div.append("<div id='"+e+"'></div>"),this.div.css("overflow","hidden");var f={tableId:e,data:c.data,allFields:c.config,enableThClick:!1},g=d&&d.pagesize&&parseInt(d.pagesize)?d.pagesize:5;c.data&&c.data.length>g?f.page={size:g}:f.noPage=!0,Gri.initDataTable(f)},e.prototype._getNormalChartPlotOption=function(a,b){switch(a){case"pie_3d":case"circular":case"circular_3d":var c=a.split("_"),d=c[0],e=c[1]&&void 0!=$.inArray(c[1],["3d"])?c[1]:"";b.plotOptions={pie:{innerSize:"circular"==d?100:0,depth:45}},"3d"==e&&(b.chart.options3d={enabled:!0,alpha:45});break;case"sector":b.plotOptions={pie:{startAngle:-90,endAngle:90,center:["50%","75%"]}};break;case"circular_sector":b.plotOptions={pie:{innerSize:100,startAngle:-90,endAngle:90,center:["50%","75%"]}};break;case"pyramid":b.chart={type:a,marginRight:100},b.plotOptions={series:{dataLabels:{enabled:!0,format:"<b>{point.name}</b> ({point.y})",color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}};break;case"funnel":b.chart={type:"funnel",marginRight:100},b.plotOptions={series:{dataLabels:{enabled:!0,format:"<b>{point.name}</b> ({point.y})",color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black",softConnector:!0},neckWidth:"30%",neckHeight:"25%"}}}return b},e.prototype._getTrendChartPlotOption=function(a,b,c){switch(b.chart={type:a},b.xAxis={categories:c.categories},b.yAxis={title:{text:""},labels:{formatter:function(){return this.value}}},b.tooltip={shared:!0,crosshairs:!1,formatter:this.tipsFormatter},a){case"area_pile":case"area_percent":var d=a.split("_"),e=d[1]&&void 0!=$.inArray(d[1],["pile","percent"])?d[1]:"";"pile"==e&&(e="normal"),b.chart={type:"area"},b.plotOptions={area:{stacking:e}};break;case"column_3d":case"column_pile":case"column_percent":case"column_pile_3d":case"column_percent_3d":var d=a.split("_"),e=d[1]&&$.inArray(d[1],["3d","pile","percent"])>=0?d[1]:"",f=d[2]&&$.inArray(d[2],["3d"])>=0?d[2]:"";b.chart={type:"column"},"3d"!=e&&"3d"!=f||(b.chart.options3d={enabled:!0,alpha:15,beta:15,depth:50,viewDistance:25}),$.inArray(e,["pile","percent"])>=0&&("pile"==e&&(e="normal"),b.plotOptions={column:{stacking:e}});break;case"bar":b.plotOptions={bar:{dataLabels:{enabled:!0}}};break;case"heatmap":b.chart={type:"heatmap"},b.colorAxis={min:0,minColor:"#FFFFFF",maxColor:Highcharts.getOptions().colors[0]},b.yAxis={categories:c.ycategories,title:""},b.legend={align:"right",layout:"vertical",margin:0,verticalAlign:"top",y:25},b.tooltip={formatter:function(){return"<b>"+this.series.xAxis.categories[this.point.x]+"</b><br/><b>"+this.series.yAxis.categories[this.point.y]+"</b><br>"+this.point.value+"</b>"}};break;case"spiderweb":case"spiderweb_line":case"spiderweb_area":case"spiderweb_column":case"polar":case"polar_line":case"polar_area":case"polar_column":case"polar_column_pile":case"spiderweb_column_pile":case"polar_area_pile":case"spiderweb_area_pile":case"polar_column_percent":case"spiderweb_column_percent":case"polar_area_percent":case"spiderweb_area_percent":var d=a.split("_"),g="spiderweb"==d[0]?d[0]:"polar",e=d[1]&&void 0!=$.inArray(d[1],["line","area","column"])?d[1]:"line",f=d[2]&&void 0!=$.inArray(d[2],["pile","percent"])?d[2]:"";"pile"==f&&(f="normal"),b.chart={polar:!0,type:e},b.xAxis={categories:c.categories,tickmarkPlacement:"on",lineWidth:0},"spiderweb"==g&&(b.yAxis={gridLineInterpolation:"polygon",lineWidth:0,min:0}),b.tooltip={shared:!0,pointFormat:'<span style="color:{series.color}">{series.name}: <b>{point.y}</b><br/>'},""!=f&&(b.plotOptions={series:{stacking:f,shadow:!1,groupPadding:0,pointPlacement:"on"}})}return b},e.prototype.tipsFormatter=function(){for(var a="<b>"+this.x+"</b><br/>",b=0;b<this.points.length;++b){var c=this.points[b].series.name,d=Highcharts.numberFormat(this.points[b].y,-1,".",",");a+='<span style="color:'+this.points[b].series.color+'">●</span>'+c+': <b style="color:'+this.points[b].series.color+'">'+d+"</b><br/>"}return a},e.prototype.getChartOptions=function(a,b,c){var d={};switch(d.title={text:""},d.subtitle={text:""},d.credits={enabled:!1},a){case"spline":case"column":case"area":case"bar":case"area_pile":case"area_percent":case"column_3d":case"column_pile":case"column_pile_3d":case"column_percent":case"column_percent_3d":case"heatmap":case"spiderweb":case"spiderweb_line":case"spiderweb_area":case"spiderweb_column":case"polar":case"polar_line":case"polar_area":case"polar_column":case"polar_column_pile":case"spiderweb_column_pile":case"polar_area_pile":case"spiderweb_area_pile":case"polar_column_percent":case"spiderweb_column_percent":case"polar_area_percent":case"spiderweb_area_percent":d=this._getTrendChartPlotOption(a,d,b);break;case"pie":case"pie_3d":case"circular":case"circular_3d":case"sector":case"circular_sector":case"pyramid":case"funnel":d.chart={type:"pie"},d=this._getNormalChartPlotOption(a,d)}return d.series=b.series,d},e.prototype.getChartData=function(a,b){var c=this._report_type?this._report_type:a.type;switch(c){case"spline":case"column":case"area":case"bar":case"area_pile":case"area_percent":case"column_3d":case"column_pile":case"column_pile_3d":case"column_percent":case"column_percent_3d":case"spiderweb":case"spiderweb_line":case"spiderweb_area":case"spiderweb_column":case"polar":case"polar_line":case"polar_area":case"polar_column":case"polar_column_pile":case"spiderweb_column_pile":case"polar_area_pile":case"spiderweb_area_pile":case"polar_column_percent":case"spiderweb_column_percent":case"polar_area_percent":case"spiderweb_area_percent":var d=[],e={},g=a.config;for(field in g.field_list)e[field]={name:g.field_list[field],data:[]},g.color_list&&g.color_list[field]&&(e[field].color=g.color_list[field]),g.line_list&&g.line_list[field]&&(e[field].dashStyle=g.line_list[field]);for(key in a.data){d.push(key);for(field in g.field_list)e[field].data.push(parseFloat(a.data[key][field]||null))}return{categories:d,series:Object.values(e)};case"pie":case"pie_3d":case"circular":case"circular_3d":case"sector":case"circular_sector":case"pyramid":case"funnel":var e=[{name:"",data:[]}],h={};a.config.color_list&&(h=a.config.color_list);var i=Object.values(a.data).pop();for(field in a.config.field_list){var j={name:a.config.field_list[field],y:parseFloat(i[field]||0)};h[field]&&(j.color=h[field]),e[0].data.push(j)}return{series:e};case"heatmap":var d=[],k=[],e=[{name:"",data:[],dataLabels:{enabled:!0}}],g=a.config,l={},m=0;for(field in g.field_list)l[field]=m,k.push(g.field_list[field]),m++;var n=0;for(key in a.data){d.push(key);for(f in l)e[0].data.push([n,l[f],parseFloat(a.data[key][f]||null)]);n++}return{ycategories:k,categories:d,series:e}}},e.prototype.showChart=function(b,c,d){if(void 0==a.Highcharts)return this._show_msg("本报表需要载入Highcharts组件"),!1;var e=this.getChartData(c,d),f=this._report_type?this._report_type:c.type;options=this.getChartOptions(f,e,d),this.div.highcharts(options,function(a){$("text").each(function(){"Highcharts.com"==$(this).html()&&$(this).hide()})})},e.prototype._show_msg=function(a){this.div.html("<span style='padding: 5px;color:red;display:inline-block;'>"+a+"</span>")},a.EZ=a.EZ||{},EZ.reportDisplay=d}(this);